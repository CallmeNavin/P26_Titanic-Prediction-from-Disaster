import pandas as pd
df_train = pd.read_csv('p26_titanic_prediction_from_disaster/I_raw/Titanic_train.csv')
df_test = pd.read_csv('p26_titanic_prediction_from_disaster/I_raw/Titanic_test.csv')

print('Train Data Checking')
print(df_train.describe())
print(df_train.info())
print('Test Data Checking')
print(df_test.describe())
print(df_test.info())

print('Remove Unecessary Columns')
df_train = df_train.drop(columns=['Cabin'])
df_test = df_test.drop(columns=['Cabin'])
print('Columns Removed')
print('Handling Missing Values for Age')
df_train['Age'] = df_train['Age'].fillna(df_train['Age'].median())
df_test['Age'] = df_test['Age'].fillna(df_test['Age'].median())
print('Missing Values Handled for Age')
print('Handling Missing Values for Embarked')
df_train['Embarked'] = df_train['Embarked'].fillna(df_train['Embarked'].mode()[0])
df_test['Embarked'] = df_test['Embarked'].fillna(df_test['Embarked'].mode()[0])
print('Missing Values Handled for Embarked')
print('Handling Missing Values for Fare in Test Set')
df_test['Fare'] = df_test['Fare'].fillna(df_test['Fare'].median())
print('Missing Values Handled for Fare in Test Set')

print('Encoding Categorical Variables')
df_train['Sex'] = df_train['Sex'].map({'male': 0, 'female': 1})
df_test['Sex'] = df_test['Sex'].map({'male': 0, 'female': 1})
df_train = pd.get_dummies(df_train, columns= ['Embarked'], drop_first=True)
df_test = pd.get_dummies(df_test, columns= ['Embarked'], drop_first=True)
print('Encoding Categorical Variables Completed')

print('Split x and y for Training Set')
x = df_train.drop(columns=['Survived', 'PassengerId', 'Name', 'Ticket'])
y = df_train['Survived']
print('Split Completed')
print('Split train & validation sets in train data')
from sklearn.model_selection import train_test_split
x_train, x_val, y_train, y_val = train_test_split(x, y, test_size=0.2, random_state=42, stratify=y)
print('Split train & validation sets Completed')

print('Train Logistic Regression Model')
from sklearn.linear_model import LogisticRegression
lr_model = LogisticRegression(max_iter=1000)
lr_model.fit(x_train, y_train)
print('Model Training Completed')
print('Evaluate Model on Validation Data')
y_val_pred = lr_model.predict(x_val)
y_val_proba = lr_model.predict_proba(x_val)[:, 1]
from sklearn.metrics import accuracy_score, precision_score, recall_score, f1_score, roc_auc_score, confusion_matrix
lr_accuracy = accuracy_score(y_val, y_val_pred)
lr_precision = precision_score(y_val, y_val_pred)
lr_recall = recall_score(y_val, y_val_pred)
lr_f1 = f1_score(y_val, y_val_pred)
lr_roc_auc = roc_auc_score(y_val, y_val_proba)
lr_conf_matrix = confusion_matrix(y_val, y_val_pred)
print(f'Logistic Regression Validation Accuracy: {lr_accuracy}')
print(f'Logistic Regression Validation Precision: {lr_precision}')
print(f'Logistic Regression Validation Recall: {lr_recall}')
print(f'Logistic Regression Validation F1 Score: {lr_f1}')
print(f'Logistic Regression Validation ROC AUC: {lr_roc_auc}')
print('Confusion Matrix:')
print(lr_conf_matrix)

print('Predict on Test Data')
test_pred = lr_model.predict(df_test.drop(columns=['PassengerId', 'Name', 'Ticket']))
final_predict = pd.DataFrame({'PassengerId': df_test['PassengerId'], 'Survived': test_pred})
final_predict.to_csv('p26_titanic_prediction_from_disaster/III_output/final_predict.csv', index= False)
print('Predictions Saved to final_predict.csv')

print('Feature Coefficients from Logistic Regression Model')
coef_df = pd.DataFrame({'Feature': x.columns,'Coefficient': lr_model.coef_[0]}).sort_values(by='Coefficient', ascending=False)
print(coef_df)